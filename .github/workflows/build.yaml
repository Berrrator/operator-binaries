name: Build binaries

on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        goos: [linux, darwin, windows]
        goarch: [amd64, arm64]
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-go@v5
        with:
          go-version: "1.25.x"
      - run: |
          mkdir -p binaries
          OUT="binaries/operator_wrapper_${{ matrix.goos }}_${{ matrix.goarch }}"
          [[ "${{ matrix.goos }}" == "windows" ]] && OUT="${OUT}.exe"
          GOOS=${{ matrix.goos }} GOARCH=${{ matrix.goarch }} CGO_ENABLED=0 \
            go build -trimpath -ldflags="-s -w" -o "$OUT" main.go
      - uses: actions/upload-artifact@v4
        with:
          name: operator_wrapper_${{ matrix.goos }}_${{ matrix.goarch }}
          path: ${{ matrix.goos == 'windows' && format('binaries/operator_wrapper_{0}_{1}.exe', matrix.goos, matrix.goarch) || format('binaries/operator_wrapper_{0}_{1}', matrix.goos, matrix.goarch) }}

release:
  needs: build
  runs-on: ubuntu-latest
  steps:
    - name: Download all artifacts
      uses: actions/download-artifact@v4
      with:
        path: binaries

    - name: Publish GitHub Release
      uses: softprops/action-gh-release@v1
      with:
        files: binaries/**
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
